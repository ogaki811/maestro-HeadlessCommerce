// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Headless Commerce - Multi-Business Type Models
// ヘッドレスコマース - マルチ商流モデル
// ==========================================

/// Product (商品マスター)
model Product {
  id          String   @id @default(cuid())
  code        String   @unique // Product code
  name        String
  description String?  @db.Text
  category    String
  imageUrl    String?
  availableFor String[] // ['toc', 'wholesale', 'retail'] - Which business types can access
  isActive    Boolean  @default(true)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  prices     ProductPrice[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([code])
  @@index([category])
  @@map("products")
}

/// ProductPrice (商流別価格)
model ProductPrice {
  id           String   @id @default(cuid())
  productId    String
  businessType String   // 'toc', 'wholesale', 'retail'
  basePrice    Decimal  @db.Decimal(10, 2)
  taxRate      Decimal  @default(0.10) @db.Decimal(5, 2)
  minOrderQty  Int      @default(1)
  volumePrices Json?    // Volume discount tiers for wholesale
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, businessType])
  @@index([businessType])
  @@map("product_prices")
}

/// Customer (顧客)
model Customer {
  id           String   @id @default(cuid())
  businessType String   // 'toc', 'wholesale', 'retail'
  email        String   @unique
  name         String
  dealerCode   String?  @unique // TOC only
  companyCode  String?  @unique // Wholesale only
  companyName  String?  // For B2B customers
  phone        String?
  address      Json?    // Shipping/billing address
  points       Int      @default(0) // TOC/Retail only
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders Order[]
  carts  Cart[]

  @@index([businessType])
  @@index([email])
  @@map("customers")
}

/// Cart (カート)
model Cart {
  id           String   @id @default(cuid())
  customerId   String?
  sessionId    String?  // For guest users
  businessType String   // 'toc', 'wholesale', 'retail'
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer  Customer?  @relation(fields: [customerId], references: [id])
  cartItems CartItem[]

  @@index([customerId])
  @@index([sessionId])
  @@index([businessType])
  @@map("carts")
}

/// CartItem (カート明細)
model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) // Price at the time of adding to cart
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

/// Order (注文)
model Order {
  id             String   @id @default(cuid())
  orderNumber    String   @unique
  customerId     String
  businessType   String   // 'toc', 'wholesale', 'retail'
  status         String   // 'pending', 'confirmed', 'shipped', 'delivered', 'cancelled'
  totalAmount    Decimal  @db.Decimal(12, 2)
  taxAmount      Decimal  @db.Decimal(12, 2)
  shippingAmount Decimal  @default(0) @db.Decimal(10, 2)
  pointsUsed     Int      @default(0)
  pointsEarned   Int      @default(0)
  paymentMethod  String   // 'invoice', 'bank_transfer', 'credit_card', etc.
  paymentStatus  String   @default("pending") // 'pending', 'paid', 'failed'
  shippingAddress Json
  billingAddress  Json?
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer   Customer    @relation(fields: [customerId], references: [id])
  orderItems OrderItem[]

  @@index([customerId])
  @@index([businessType])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

/// OrderItem (注文明細)
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productCode String   // Snapshot at order time
  productName String   // Snapshot at order time
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @db.Decimal(5, 2)
  createdAt   DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}
