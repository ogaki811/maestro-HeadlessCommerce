# 購入データダウンロード機能 仕様書

## 概要

過去18ヶ月の購入データを条件指定してCSVまたはExcel形式でダウンロードできる機能。

### 対象ユーザー
- TOC（ディーラー）
- Wholesale（卸売）

### 制約事項
- 過去18ヶ月分のデータが対象
- 前日までの購入データを対象（当日データは含まない）

---

## ページ情報

| 項目 | 値 |
|------|-----|
| ページパス | `/purchase-data-download` |
| ページタイトル | 購入データダウンロード |
| 認証 | 必須（TOC/Wholesale のみ） |
| ルートグループ | `(protected)` |

---

## UI仕様

### ページ構成

```
┌─────────────────────────────────────────────────────────┐
│ 購入データダウンロード ─────────────────────────────────│
├─────────────────────────────────────────────────────────┤
│ ・過去18ヶ月の購入データの中から、条件を指定し、        │
│   パソコンにCSVまたはエクセルファイルとしてダウンロード │
│   できます。                                            │
│ ・前日までの購入データを対象としています。              │
├─────────────────────────────────────────────────────────┤
│ [エラーメッセージ表示エリア]                            │
├─────────────────────────────────────────────────────────┤
│ ■ 検索条件入力                                          │
│ ┌─────────────────────────────────────────────────────┐│
│ │ 納品日      │ [開始日] 〜 [終了日]                 ││
│ │ データ形式  │ [CSV ▼]                              ││
│ │ フォーマット│ [通常フォーマット（消費税表記無し）▼]││
│ │ 管理受託品  │ [ALL ▼]                              ││
│ │ 対象データ  │ [自分が注文したもの ▼] コード入力 []││
│ └─────────────────────────────────────────────────────┘│
│                                                         │
│        [入力クリア]  [ダウンロードデータ作成]           │
├─────────────────────────────────────────────────────────┤
│ ダウンロードしたCSVファイルをエクセルに自動展開する     │
│ ツールです。                                            │
│ また各項目の意味、レイアウトを説明した「項目説明書」も  │
│ こちらからダウンロードできます。                        │
│                                                         │
│     [エクセル展開マクロ・項目説明書はこちら]            │
└─────────────────────────────────────────────────────────┘
```

---

## 検索条件フォーム

### 1. 納品日（deliveryDateRange）

| 項目 | 仕様 |
|------|------|
| 入力形式 | 日付範囲（開始日 〜 終了日） |
| デフォルト開始日 | 18ヶ月前の1日 |
| デフォルト終了日 | 前日 |
| 入力方式 | 年・月・日 の個別入力 + カレンダーピッカー |
| バリデーション | 開始日 ≤ 終了日、18ヶ月以内 |
| 備考 | (半角) 表記 |

### 2. データ形式（dataFormat）

| 項目 | 仕様 |
|------|------|
| 入力形式 | セレクトボックス |
| 選択肢 | `CSV`, `Excel` |
| デフォルト | `CSV` |

### 3. フォーマット（format）

| 項目 | 仕様 |
|------|------|
| 入力形式 | セレクトボックス |
| 選択肢 | `通常フォーマット（消費税表記無し）`, `通常フォーマット（消費税表記有り）` |
| デフォルト | `通常フォーマット（消費税表記無し）` |

### 4. 管理受託品（consignmentFilter）

| 項目 | 仕様 |
|------|------|
| 入力形式 | セレクトボックス |
| 選択肢 | `ALL`, `管理受託品のみ`, `管理受託品以外` |
| デフォルト | `ALL` |

### 5. 対象データ（targetData）

| 項目 | 仕様 |
|------|------|
| 入力形式 | セレクトボックス + テキスト入力 |
| 選択肢 | `自分が注文したもの`, `指定コードの注文` |
| デフォルト | `自分が注文したもの` |
| コード入力 | 半角英数字、「指定コードの注文」選択時のみ有効 |

---

## ボタンアクション

### 入力クリアボタン

- 全ての入力をデフォルト値にリセット
- スタイル: グレー背景

### ダウンロードデータ作成ボタン

- 検索条件に基づいてデータを生成しダウンロード
- スタイル: オレンジ/茶色背景（プライマリボタン）
- クリック時の処理:
  1. バリデーション実行
  2. APIリクエスト送信
  3. 成功時: ファイルダウンロード開始
  4. 失敗時: エラーメッセージ表示

### エクセル展開マクロ・項目説明書ボタン

- 外部リンクまたはファイルダウンロード
- スタイル: ティール/青緑背景

---

## エラーメッセージ

| 状況 | メッセージ |
|------|----------|
| データなし | 検索条件に該当する購入データが見つかりませんでした。 |
| 日付範囲エラー | 開始日は終了日以前の日付を指定してください。 |
| 期間超過 | 検索期間は18ヶ月以内で指定してください。 |
| API エラー | データの取得に失敗しました。時間をおいて再度お試しください。 |

- エラーメッセージは赤文字で表示

---

## API仕様

### エンドポイント

```
POST /api/purchase-data/download
```

### リクエストボディ

```typescript
interface PurchaseDataDownloadRequest {
  startDate: string;        // YYYY-MM-DD形式
  endDate: string;          // YYYY-MM-DD形式
  dataFormat: 'csv' | 'excel';
  format: 'normal' | 'normal_with_tax';
  consignmentFilter: 'all' | 'consignment_only' | 'non_consignment';
  targetData: 'own' | 'specified';
  specifiedCode?: string;   // targetData === 'specified' の場合のみ
}
```

### レスポンス

**成功時（200）**
- Content-Type: `text/csv` または `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- Content-Disposition: `attachment; filename="purchase_data_YYYYMMDD.csv"`

**エラー時**
```typescript
interface ErrorResponse {
  error: string;
  message: string;
}
```

| ステータス | 状況 |
|-----------|------|
| 400 | バリデーションエラー |
| 401 | 未認証 |
| 403 | 権限なし（Retail ユーザー） |
| 404 | データなし |
| 500 | サーバーエラー |

---

## ダウンロードCSVフォーマット

### 通常フォーマット（消費税表記無し）

| カラム名 | 説明 |
|---------|------|
| 注文番号 | Order number |
| 注文日 | Order date (YYYY/MM/DD) |
| 納品日 | Delivery date (YYYY/MM/DD) |
| 商品コード | Product code |
| 商品名 | Product name |
| 数量 | Quantity |
| 単価 | Unit price |
| 金額 | Total amount |
| 管理受託品フラグ | Consignment flag (0/1) |

### 通常フォーマット（消費税表記有り）

上記に加えて:

| カラム名 | 説明 |
|---------|------|
| 税率 | Tax rate (%) |
| 税額 | Tax amount |
| 税込金額 | Amount including tax |

---

## コンポーネント構成

```
src/
├── app/
│   └── (protected)/
│       └── purchase-data-download/
│           └── page.tsx                    # ページコンポーネント
├── components/
│   └── purchase-data-download/
│       ├── PurchaseDataDownloadForm.tsx    # メインフォーム（Organism）
│       ├── DateRangeInput.tsx              # 日付範囲入力（Molecule）
│       ├── DownloadFormatSelector.tsx      # フォーマット選択（Molecule）
│       └── __tests__/
│           ├── PurchaseDataDownloadForm.test.tsx
│           └── DateRangeInput.test.tsx
└── app/
    └── api/
        └── purchase-data/
            └── download/
                └── route.ts                # APIエンドポイント
```

---

## 実装優先度

1. **Phase 1**: UI実装（フォーム、バリデーション）
2. **Phase 2**: API実装（ダウンロード処理）
3. **Phase 3**: CSV/Excel生成ロジック
4. **Phase 4**: テスト作成
5. **Phase 5**: ヘルプドキュメント・マクロダウンロード

---

## 技術的考慮事項

### SSR対応
- フォームはクライアントコンポーネント（`'use client'`）
- 日付ピッカーはブラウザAPIを使用

### パフォーマンス
- 大量データの場合はストリーミングダウンロード検討
- 18ヶ月分のデータは件数制限またはページング

### セキュリティ
- 認証必須（NextAuth.js セッション確認）
- ビジネスタイプチェック（TOC/Wholesale のみ許可）
- SQLインジェクション対策（Prisma使用）

---

## 参考

- デザインキャプチャ: `/Users/ogawayuuki/Desktop/スクリーンショット 2025-11-23 19.42.01.png`
- 作成日: 2025-11-23
- ブランチ: `feature/purchase-data-download`
