# 掲載外商品取寄せ機能 - 仕様書

## 1. 機能概要と目的

### 概要
ECサイトに掲載されていない商品を担当販売店に依頼し、別ルートで調達・納品してもらうための連絡・管理機能。

### 目的
- カタログ外商品の取寄せ依頼を販売店に送信
- 過去の取寄せ履歴を管理
- よく注文する商品を定番として登録・再利用

### システムの位置づけ
- 通常のECカート機能とは完全に独立
- 販売店へのメール送信はバックエンドが処理（フロントエンド実装不要）
- 法人内全体で定番・履歴を共有

### 対象外の機能
- ❌ ポイント付与・利用
- ❌ 通常の注文履歴への記録
- ❌ 購入データダウンロード
- ❌ 環境配慮レポート
- ❌ smartoffice配送リードタイムルール
- ❌ smartoffice返品ルール

---

### ビジネス目的と価値提案

#### なぜこの機能が必要か
1. **商品取扱範囲の拡大**
   - ECサイトのカタログに掲載されていない商品でも顧客ニーズに応えられる
   - カタログ外商品の取寄せ手段がない場合、顧客は他社に流れてしまう可能性がある

2. **販売機会の最大化**
   - カタログ掲載品以外の特殊な商品や、メーカー直送品、一時的な商品の依頼に対応
   - 顧客の「これも欲しい」というニーズを逃さない

3. **業務効率化**
   - 電話・FAXでの取寄せ依頼を減らし、システム化による効率化
   - 依頼履歴の一元管理により、定番化や再オーダーが容易

4. **販売店との連携強化**
   - 取寄せ依頼を通じて販売店とのコミュニケーションを促進
   - 顧客の特殊ニーズを販売店が把握できる

#### 解決するビジネス課題
- **課題1**: カタログ外商品の依頼方法が電話・FAXのみで非効率
- **課題2**: 過去の取寄せ依頼履歴が残らず、再注文時に毎回ゼロから依頼
- **課題3**: よく注文する商品を定番化できず、毎回同じ内容を入力
- **課題4**: 法人内で取寄せ情報が共有されず、重複依頼や情報の分散

---

### 業務ワークフローとステークホルダー

#### ステークホルダー

**1. エンドユーザー（購買担当者）**
- 役割: カタログ外商品の取寄せ依頼を作成
- 関心事: 簡単に依頼できる、過去の依頼を再利用できる
- 利用シーン:
  - 特殊な規格の商品が必要になった
  - カタログにない新商品を試したい
  - 過去に取り寄せた商品をもう一度注文したい

**2. 承認者（上長・購買管理者）**
- 役割: 承認設定がある場合、取寄せ依頼を承認・却下
- 関心事: 適切な依頼かどうかを判断、予算管理
- 影響: 承認却下された依頼は定番登録不可

**3. 販売店（スマートオフィス販売店）**
- 役割: メールで依頼を受け取り、商品調達・見積作成・納品を実施
- 関心事: 依頼内容が明確か、納期・価格の調整が必要か
- 業務フロー:
  1. 依頼メールを受信
  2. 商品の調達可否・価格・納期を確認
  3. 見積依頼の場合は見積書を作成して返信
  4. 注文の場合は商品を調達して納品
  5. 請求書を発行

**4. システム管理者**
- 役割: 承認フロー設定、販売店情報の管理
- 関心事: システムが正しく動作しているか、データの整合性

#### 業務フロー

```
[顧客企業内]
購買担当者 → システムで依頼作成 → (承認フロー※) → システムが販売店にメール送信
    ↓                                                           ↓
 履歴に保存                                              [販売店]
    ↓                                                      メール受信
定番登録可能                                                   ↓
    ↓                                                    商品調達・見積作成
再オーダー                                                     ↓
                                                         納品・請求

※承認フロー: 設定がある場合のみ
  - 承認 → メール送信 → 履歴に「注文」として記録
  - 却下 → メール送信されない → 履歴に「注文(承認却下)」として記録
```

#### 前工程・後工程との関係

**前工程:**
- 通常のEC商品検索で見つからなかった → 取寄せ依頼へ
- 過去の取寄せ履歴・定番から → 再オーダー

**後工程:**
- 見積依頼 → 販売店から見積書 → 正式注文（別途）
- 注文 → 販売店が納品 → 請求書発行 → 支払い（別システム）
- 取寄せ商品は通常のEC注文履歴には載らない

---

### ビジネスルールと制約の詳細

#### 承認フローとの連携
1. **承認設定がある法人の場合**
   - 取寄せ依頼（注文）は承認フローに回される
   - 承認されるまでメール送信されない
   - 承認者は依頼内容を確認し、承認 or 却下
   - 却下された場合、販売店にメールは送られない
   - 却下された依頼は履歴に「注文(承認却下)」として残る
   - 却下された依頼は定番登録不可

2. **承認設定がない法人の場合**
   - 依頼と同時に販売店にメール送信
   - すぐに履歴に記録される

3. **見積依頼の場合**
   - 承認フローの対象外（すぐにメール送信）
   - 見積後の正式注文は別途行う

#### 権限とアクセス制御
- この機能は全ユーザーが利用可能（super_admin, admin, general）
- 定番・履歴は法人内全体で共有
- 「自分が入力したモノのみ表示」フィルターで個人の依頼に絞り込み可能

#### 他機能との統合・非統合
**統合:**
- ✅ 承認フロー（承認システムとの連携）
- ✅ メール送信（販売店への通知）
- ✅ ユーザー認証（ログインユーザーの情報）

**非統合:**
- ❌ ECカート（カート機能とは完全に独立）
- ❌ ポイントシステム（ポイント付与・利用なし）
- ❌ 注文履歴（通常のEC注文履歴には記録されない）
- ❌ 購入データDL（この機能の依頼は対象外）
- ❌ 環境配慮レポート（この機能の依頼は対象外）
- ❌ 配送追跡（販売店が直接納品）

---

### システム統合の詳細

#### メール送信
**タイミング:**
- 承認不要 or 見積依頼: 依頼と同時
- 承認必要（注文）: 承認完了時

**送信先:**
- 担当販売店のメールアドレス（店舗ごとに設定）

**メール内容:**
- 依頼種別（見積依頼 / 注文）
- 依頼者情報（氏名、会社名、連絡先）
- 商品情報（商品名、メーカー名、数量、単位、備考）
- 依頼日時

**送信後のフォローアップ:**
- バックエンドでメール送信ログを記録
- 送信失敗時のリトライ機構（バックエンド実装）
- 販売店からの返信は別途メール or 電話で対応（システム外）

#### 承認システムとの連携
**承認フロー:**
1. ユーザーが「注文」で依頼作成
2. 承認設定がある場合、承認待ち状態で保存
3. 承認者に通知メール送信（承認システム）
4. 承認者が承認 → 販売店にメール送信 + 履歴に「注文」として記録
5. 承認者が却下 → 販売店にメールは送らない + 履歴に「注文(承認却下)」として記録

**承認データ:**
- 依頼ID、依頼者、依頼内容、承認状態、承認者、承認日時

#### データ保存
**履歴データ:**
- 全ての依頼（承認済み・却下・見積）を履歴に保存
- 法人内全体で共有（検索・フィルター可能）
- 削除不可（監査証跡として残す）

**定番データ:**
- ユーザーが手動で登録（履歴から登録 or 自動登録）
- 法人内全体で共有
- 削除可能（不要になった定番は削除）

#### エラー処理
**メール送信失敗時:**
- バックエンドでリトライ（最大3回）
- 失敗した場合、管理者に通知
- ユーザーには成功として表示（後からメール送信）

**承認タイムアウト:**
- 承認待ち状態が一定期間（例: 7日）続いた場合、リマインドメール送信
- さらに一定期間（例: 14日）承認されない場合、自動却下

**販売店からの返信がない場合:**
- システムでは追跡しない
- ユーザーが直接販売店に問い合わせ（電話 or メール）

---

## 2. 機能要件

### 2.1 トップページ
- 取寄せ依頼・定番一覧・履歴一覧への導線
- 注意事項の表示
- 担当販売店情報の表示

### 2.2 取寄せ依頼フォーム
- 種別選択（見積依頼 or 注文）
- 商品情報を最大10行入力
- 依頼送信（バックエンドで販売店にメール送信）

### 2.3 取寄せ定番一覧
- 定番リストの表示・検索・フィルター
- 定番から再オーダー
- 定番の削除
- 一括再オーダー

### 2.4 過去の取寄せ一覧
- 履歴の表示・検索・フィルター
- 履歴から再オーダー
- 履歴から定番登録
- 一括操作（再オーダー・定番登録）

---

## 3. UI/UX仕様

### 3.1 トップページ (`/mypage/special-order`)

#### レイアウト
```
┌─────────────────────────────────────┐
│ Header                               │
├─────────────────────────────────────┤
│ Breadcrumb                           │
├────────┬────────────────────────────┤
│        │ [販売店対応] バッジ（赤）   │
│ Side   │ カタログ掲載外取寄せ        │
│ bar    │                            │
│        │ 説明文                      │
│        │                            │
│        │ ┌────────────────────────┐ │
│        │ │ 取寄せ依頼 (オレンジ)   │ │
│        │ └────────────────────────┘ │
│        │ ┌────────────────────────┐ │
│        │ │ 取寄せ定番一覧 (白枠)   │ │
│        │ └────────────────────────┘ │
│        │ ┌────────────────────────┐ │
│        │ │ 過去の取寄せ一覧(ピンク)│ │
│        │ └────────────────────────┘ │
│        │                            │
│        │ 【注意事項】                │
│        │ ・承認設定時は承認対象      │
│        │ ・ポイント対象外            │
│        │ ・配送リードタイム適用外    │
│        │ ・返品ルール適用外          │
│        │ ・カタログ掲載品入力不可    │
│        │ ・履歴DL・環境レポート対象外│
│        │                            │
│        │ 担当販売店情報              │
│        │ ┌────────────────────────┐ │
│        │ │ スマートオフィス販売店   │ │
│        │ │ 営業担当：長谷部          │ │
│        │ │ TEL: 0358774860         │ │
│        │ │ FAX: -                  │ │
│        │ │ Email: xxx@xxx.jp       │ │
│        │ └────────────────────────┘ │
└────────┴────────────────────────────┘
│ Footer                               │
└─────────────────────────────────────┘
```

#### コンポーネント
- **ActionButtons** (Molecule)
  - 3つのボタン（取寄せ依頼・定番一覧・履歴一覧）
- **NoticeSection** (Molecule)
  - 箇条書き6項目
- **StoreInfo** (Molecule)
  - 店舗名・担当者・連絡先

---

### 3.2 取寄せ依頼フォーム (`/mypage/special-order/new`)

#### レイアウト
```
┌─────────────────────────────────────┐
│ [販売店対応] バッジ                   │
│ カタログ掲載外取寄せ・取寄せ依頼      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━         │
│                                     │
│ 担当販売店【xxx】に対して、          │
│ カタログ掲載外商品の取寄せ依頼を      │
│ 行います。                           │
│                                     │
│ 種別                                 │
│ ○ 見積依頼  ○ 注文                  │
│                                     │
│ 商品明細                             │
│ ※1. 品番、注文コード、色、サイズ...  │
│ ※2. 「枚」「冊」「箱」等の数量単位... │
│                                     │
│ ┌───┬──────┬────┬───┬───┬────┐
│ │行 │商品名  │メーカ│数量│単位│備考│
│ ├───┼──────┼────┼───┼───┼────┤
│ │ 1 │        │      │    │    │    │
│ │ 2 │        │      │    │    │    │
│ │...│        │      │    │    │    │
│ │10 │        │      │    │    │    │
│ └───┴──────┴────┴───┴───┴────┘
│                                     │
│ ┌──────────┐ ┌──────┐ ┌────┐     │
│ │依頼を行う  │ │クリア│ │戻る│     │
│ └──────────┘ └──────┘ └────┘     │
└─────────────────────────────────────┘
```

#### フォームフィールド

**種別（ラジオボタン）**
- デフォルト: 見積依頼
- オプション: 見積依頼 / 注文

**商品明細テーブル（10行固定）**

| フィールド | 必須 | 最大文字数 | プレースホルダー |
|----------|------|-----------|----------------|
| 商品名 | ✅ | 全角50桁（半角100桁） | 全角50桁（半角100桁） |
| メーカー名 | - | 全角20桁（半角40桁） | 全角20桁（半角40桁） |
| 数量 | - | 半角5桁 | 半角5桁 |
| 単位 | ✅※ | 全角5桁 | 全角5桁 |
| 備考 | - | 全角20桁（半角40桁） | 全角20桁（半角40桁） |

※商品名を入力した行は単位必須

#### バリデーションルール
1. **最低1行入力必須**: 商品名 + 単位が入力された行が1つ以上
2. **商品名入力時、単位必須**: 商品名を入力した行は単位も必須
3. **文字数制限**: 各フィールドの最大文字数チェック
4. **数量は数値のみ**: 半角数字のみ許可

#### インタラクション
- **依頼を行う**: バリデーション → API送信 → 成功メッセージ → トップページへ遷移
- **入力クリア**: 確認ダイアログ → フォームリセット
- **戻る**: トップページへ遷移

#### URL遷移パターン
- `/mypage/special-order/new` - 新規作成
- `/mypage/special-order/new?templateId=xxx` - 定番から再オーダー（データ自動入力）
- `/mypage/special-order/new?templateIds=xxx,yyy` - 定番一括再オーダー
- `/mypage/special-order/new?historyId=xxx` - 履歴から再オーダー
- `/mypage/special-order/new?historyIds=xxx,yyy` - 履歴一括再オーダー

---

### 3.3 取寄せ定番一覧 (`/mypage/special-order/templates`)

#### レイアウト
```
┌─────────────────────────────────────┐
│ [販売店対応] バッジ                   │
│ カタログ掲載外取寄せ・定番一覧        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━         │
│                                     │
│ 並び順 [商品名順▼] [自分が入力した  │
│                     モノのみ表示]    │
│                  [まとめて再オーダー]│
│                                     │
│ ┌─┬────┬────┬────┬────┬─┬─┬──┬────┐
│ │☐│登録日│入力者│商品名│メーカ│数│単│備考│アクション│
│ ├─┼────┼────┼────┼────┼─┼─┼──┼────┤
│ │☐│2024/1│CRM  │xxx   │xxx  │1│1│    │再オーダー│
│ │ │      │     │      │     │ │ │    │  削除  │
│ └─┴────┴────┴────┴────┴─┴─┴──┴────┘
│                                     │
│ ページネーション                     │
└─────────────────────────────────────┘
```

#### コントロール
- **並び順セレクトボックス**: 商品名順 / 登録日（新→古）/ 登録日（古→新）
- **フィルターボタン**: 自分が入力したモノのみ表示（トグル）
- **まとめて再オーダーボタン**: 選択した定番を新規依頼フォームへ

#### テーブルカラム
| カラム | 幅 | 説明 |
|--------|-----|------|
| 選択 | 固定 | チェックボックス |
| 登録日 | 100px | YYYY/MM/DD |
| 入力者 | 150px | ユーザー名 |
| 商品名 | 可変 | - |
| メーカー名 | 150px | - |
| 数量 | 80px | - |
| 単位 | 80px | - |
| 備考 | 150px | - |
| アクション | 200px | 再オーダー・削除 |

#### インタラクション
- **再オーダー**: 新規依頼フォームへ遷移（データ自動入力）
- **削除**: 確認ダイアログ → DELETE API → リスト更新
- **まとめて再オーダー**: チェックした行を新規依頼フォームへ

---

### 3.4 過去の取寄せ一覧 (`/mypage/special-order/history`)

#### レイアウト
```
┌─────────────────────────────────────┐
│ [販売店対応] バッジ                   │
│ カタログ掲載外取寄せ・過去の取寄せ一覧│
│ ━━━━━━━━━━━━━━━━━━━━━━━━━         │
│                                     │
│ ┌────────────────────┐ [🔍]        │
│ │商品名、メーカー名を入力│             │
│ └────────────────────┘             │
│                                     │
│ 並び順 [商品名順▼] [自分が入力した  │
│                     モノのみ表示]    │
│           [まとめて再オーダー]       │
│           [まとめて定番登録]         │
│                                     │
│ ┌─┬──┬────┬────┬────┬────┬─┬─┬──┬────┐
│ │☐│種│依頼日│入力者│商品名│メーカ│数│単│備考│アクション│
│ ├─┼──┼────┼────┼────┼────┼─┼─┼──┼────┤
│ │☐│見│2024/3│CRM  │xxx   │xxx  │1│1│    │再オーダー│
│ │ │積│      │     │      │     │ │ │    │定番登録 │
│ └─┴──┴────┴────┴────┴────┴─┴─┴──┴────┘
│                                     │
│ ページネーション                     │
└─────────────────────────────────────┘
```

#### 検索
- **検索ボックス**: 商品名・メーカー名で部分一致検索
- **検索ボタン**: オレンジ、虫眼鏡アイコン

#### コントロール
- **並び順セレクトボックス**: 商品名順 / 依頼日（新→古）/ 依頼日（古→新）
- **フィルターボタン**: 自分が入力したモノのみ表示
- **まとめて再オーダーボタン**: 選択した履歴を新規依頼フォームへ
- **まとめて定番登録ボタン**: 選択した履歴を定番に登録

#### テーブルカラム
| カラム | 幅 | 説明 |
|--------|-----|------|
| 選択 | 固定 | チェックボックス |
| 種別 | 100px | 見積/注文/注文(承認却下) |
| 依頼日 | 100px | YYYY/MM/DD |
| 入力者 | 150px | ユーザー名 |
| 商品名 | 可変 | - |
| メーカー名 | 150px | - |
| 数量 | 80px | - |
| 単位 | 80px | - |
| 備考 | 150px | - |
| アクション | 200px | 再オーダー・定番登録※ |

※承認却下された注文は定番登録ボタン非表示

#### 種別表示
- **見積**: 見積依頼として送信
- **注文**: 注文として送信
- **注文(承認却下)**: 承認フローで却下された注文

#### インタラクション
- **再オーダー**: 新規依頼フォームへ遷移（データ自動入力）
- **定番登録**: POST API → 成功メッセージ
- **まとめて再オーダー**: チェックした行を新規依頼フォームへ
- **まとめて定番登録**: チェックした行を定番登録 → 成功メッセージ

---

## 4. API仕様

### 4.1 新規取寄せ依頼

**エンドポイント**: `POST /api/special-order`

**リクエスト**:
```typescript
{
  type: 'quote' | 'order',
  items: [
    {
      productName: string,      // 必須、全角50桁
      manufacturer?: string,    // 全角20桁
      quantity?: number,        // 半角5桁
      unit: string,             // 必須、全角5桁
      note?: string             // 全角20桁
    }
  ]
}
```

**レスポンス**:
```typescript
{
  success: boolean,
  message: string,
  data?: {
    orderId: string,
    createdAt: string
  }
}
```

**バックエンド処理**:
1. データバリデーション
2. 履歴DBに保存
3. 販売店にメール送信
4. 承認設定がある場合は承認フローに回す

---

### 4.2 定番一覧取得

**エンドポイント**: `GET /api/special-order/templates`

**クエリパラメータ**:
- `sort`: `product_name` | `registered_date_desc` | `registered_date_asc`
- `myOnly`: `true` | `false` (自分が入力したモノのみ)
- `page`: number (ページ番号)
- `limit`: number (1ページあたりの件数)

**レスポンス**:
```typescript
{
  success: boolean,
  data: {
    templates: [
      {
        id: string,
        registeredDate: string,
        createdBy: string,
        productName: string,
        manufacturer: string,
        quantity: number,
        unit: string,
        note: string,
        isMyTemplate: boolean
      }
    ],
    total: number,
    page: number,
    limit: number
  }
}
```

---

### 4.3 定番削除

**エンドポイント**: `DELETE /api/special-order/templates/:id`

**レスポンス**:
```typescript
{
  success: boolean,
  message: string
}
```

---

### 4.4 履歴一覧取得

**エンドポイント**: `GET /api/special-order/history`

**クエリパラメータ**:
- `search`: string (商品名・メーカー名)
- `sort`: `product_name` | `order_date_desc` | `order_date_asc`
- `myOnly`: `true` | `false`
- `page`: number
- `limit`: number

**レスポンス**:
```typescript
{
  success: boolean,
  data: {
    history: [
      {
        id: string,
        type: 'quote' | 'order' | 'order_rejected',
        orderDate: string,
        createdBy: string,
        productName: string,
        manufacturer: string,
        quantity: number,
        unit: string,
        note: string,
        canAddToTemplate: boolean,  // 定番登録可能か
        isMyOrder: boolean
      }
    ],
    total: number,
    page: number,
    limit: number
  }
}
```

---

### 4.5 履歴から定番登録

**エンドポイント**: `POST /api/special-order/history/add-to-template`

**リクエスト**:
```typescript
{
  historyIds: string[]
}
```

**レスポンス**:
```typescript
{
  success: boolean,
  message: string,
  data?: {
    added: number  // 追加された件数
  }
}
```

---

## 5. バリデーションルール

### 5.1 取寄せ依頼フォーム

#### 必須チェック
- 最低1行入力必須（商品名 + 単位）
- 商品名を入力した行は単位も必須

#### 文字数チェック
- 商品名: 全角50桁（半角100桁）以内
- メーカー名: 全角20桁（半角40桁）以内
- 数量: 半角5桁以内
- 単位: 全角5桁以内
- 備考: 全角20桁（半角40桁）以内

#### 形式チェック
- 数量: 半角数字のみ

#### エラーメッセージ
- 「最低1行は商品名と単位を入力してください」
- 「商品名を入力した場合は単位も入力してください」
- 「○○は△△文字以内で入力してください」
- 「数量は半角数字で入力してください」

---

### 5.2 定番登録

#### ルール
- 承認却下された注文は定番登録不可
- `canAddToTemplate: false` の履歴は定番登録ボタン非表示

---

## 6. ファイル構造

### 6.1 型定義
```
src/types/special-order.ts
```

### 6.2 ページ
```
src/app/mypage/special-order/
├── page.tsx                    # トップページ
├── new/
│   └── page.tsx                # 取寄せ依頼フォーム
├── templates/
│   └── page.tsx                # 定番一覧
└── history/
    └── page.tsx                # 履歴一覧
```

### 6.3 コンポーネント
```
src/components/special-order/
├── SpecialOrderTopPage.tsx     # トップページコンポーネント
├── ActionButtons.tsx           # 3つのアクションボタン
├── NoticeSection.tsx           # 注意事項
├── StoreInfo.tsx               # 販売店情報
├── SpecialOrderForm.tsx        # 取寄せ依頼フォーム
├── TypeSelector.tsx            # 種別選択
├── OrderTable.tsx              # 商品明細テーブル
├── OrderRow.tsx                # 商品明細行
├── OrderNotice.tsx             # 注意事項（テーブル上部）
├── FormActions.tsx             # フォームボタン
├── TemplateList.tsx            # 定番一覧
├── TemplateControls.tsx        # 定番コントロール
├── TemplateTable.tsx           # 定番テーブル
├── TemplateRow.tsx             # 定番行
├── HistoryList.tsx             # 履歴一覧
├── HistorySearchBar.tsx        # 検索バー
├── HistoryControls.tsx         # 履歴コントロール
├── HistoryTable.tsx            # 履歴テーブル
├── HistoryRow.tsx              # 履歴行
└── TypeBadge.tsx               # 種別バッジ
```

### 6.4 API
```
src/app/api/special-order/
├── route.ts                    # POST /api/special-order
├── templates/
│   ├── route.ts                # GET /api/special-order/templates
│   └── [id]/
│       └── route.ts            # DELETE /api/special-order/templates/:id
└── history/
    ├── route.ts                # GET /api/special-order/history
    └── add-to-template/
        └── route.ts            # POST /api/special-order/history/add-to-template
```

### 6.5 テスト
```
src/components/special-order/__tests__/
├── SpecialOrderForm.test.tsx
├── TemplateList.test.tsx
└── HistoryList.test.tsx
```

---

## 7. データフロー

### 7.1 新規依頼作成
```
ユーザー入力
  ↓
バリデーション
  ↓
POST /api/special-order
  ↓
バックエンド処理
  ├─ 履歴DBに保存
  ├─ 販売店にメール送信
  └─ 承認フロー（設定時）
  ↓
成功レスポンス
  ↓
トップページへ遷移
```

### 7.2 定番から再オーダー
```
定番一覧で「再オーダー」クリック
  ↓
/mypage/special-order/new?templateId=xxx
  ↓
定番データを取得してフォームに自動入力
  ↓
ユーザーが確認・修正
  ↓
「依頼を行う」クリック
  ↓
POST /api/special-order
```

### 7.3 履歴から定番登録
```
履歴一覧で「定番登録」クリック
  ↓
POST /api/special-order/history/add-to-template
  ↓
定番リストに追加
  ↓
成功メッセージ表示
```

---

## 8. モックデータ（開発用）

### 8.1 販売店情報
```typescript
const storeInfo = {
  storeName: 'スマートオフィス販売店',
  department: '営業担当',
  contact: '長谷部',
  tel: '0358774860',
  fax: '-',
  email: 'ahasebe@jointex.jp'
};
```

### 8.2 定番データ例
```typescript
const mockTemplates = [
  {
    id: '1',
    registeredDate: '2024/03/12',
    createdBy: 'CRM2',
    productName: '00フリクション3色 0.38本体',
    manufacturer: 'パイロット',
    quantity: 1,
    unit: '1',
    note: '',
    isMyTemplate: false
  },
  // ...
];
```

### 8.3 履歴データ例
```typescript
const mockHistory = [
  {
    id: '1',
    type: 'quote',
    orderDate: '2024/03/12',
    createdBy: 'CRM2',
    productName: '00フリクション3色 0.38本体',
    manufacturer: 'パイロット',
    quantity: 1,
    unit: '1',
    note: '',
    canAddToTemplate: true,
    isMyOrder: false
  },
  {
    id: '2',
    type: 'order_rejected',
    orderDate: '2023/01/30',
    createdBy: '埼玉支店 テスト スマート太郎',
    productName: '00フリクション3色 0.38本体',
    manufacturer: 'パイロット',
    quantity: 1,
    unit: '箱',
    note: '',
    canAddToTemplate: false,  // 承認却下は定番登録不可
    isMyOrder: true
  },
  // ...
];
```

---

## 9. 実装優先度

### Phase 1: 基本機能
1. ✅ 型定義作成
2. ✅ トップページ実装
3. ✅ 取寄せ依頼フォーム実装
4. ✅ API実装（モックデータ）

### Phase 2: 一覧・管理機能
5. ✅ 定番一覧実装
6. ✅ 履歴一覧実装
7. ✅ 検索・フィルター機能

### Phase 3: テスト・最適化
8. ✅ ユニットテスト作成
9. ✅ E2Eテスト作成
10. ✅ パフォーマンス最適化

---

## 10. 注意事項

### 開発時の注意
- TDD（テスト駆動開発）で実装
- 既存のコンポーネントを可能な限り再利用
- プロジェクトのトンマナに統一
- モバイル対応（レスポンシブデザイン）
- アクセシビリティ対応（ARIA属性、キーボード操作）

### ビジネスルール
- 承認設定がある場合は承認対象
- ポイント対象外
- 通常のEC注文履歴には記録されない
- 法人内全体で定番・履歴を共有
- 承認却下された注文は定番登録不可

---

## 11. 参考資料

- CLAUDE.md - 開発ルール
- 配送カレンダー機能仕様書 (`docs/plans/delivery-calendar-spec.md`)
- 既存のマイカタログ機能 (`src/app/my-catalog/`)
- 販売再開メール一覧機能 (`src/app/mypage/restock-alerts/`)
