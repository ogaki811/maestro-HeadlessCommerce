# クイックオーダー複数行入力機能 実装計画

## 概要
クイックオーダーページに複数行の入力フィールドを追加し、一度に複数の商品を入力・カートに追加できるようにする。

## 要件
- **初期表示**: 20行の入力フィールド
- **行追加**: 10件ずつ追加可能
- **最大行数**: 99行まで
- **カート追加**: 入力されている全ての商品を一括でカートに追加
- **カートイン不要**: 個別の「追加」ボタンは不要（削除）

## 現在の仕様（変更前）
```
1. 商品コード入力 → 商品情報表示
2. 数量入力
3. 「追加」ボタンで追加済みリストに追加
4. 追加済みリストから「カートに追加」
```

## 新仕様（変更後）
```
1. 20行の入力フィールド（商品コード + 数量）
2. リアルタイムで商品情報を検索・表示
3. 10件ずつ行を追加可能（最大99行）
4. 「カートに追加」ボタンで入力済み全商品を一括追加
```

## コンポーネント設計（Atomic Design）

### Atoms（原子）
既存のコンポーネントを再利用:
- `NumberInput` - 数量入力（⚠️ styled-jsx使用中 → Tailwind CSS化が必要）
- `ProductCodeInput` - 商品コード入力（✅ Tailwind CSS化済み）

**追加タスク:**
- `NumberInput`をTailwind CSS化（開発ルール準拠のため）

### Molecules（分子）
**新規作成:**
- `QuickOrderRow` - 1行の入力行（商品コード + 数量 + 商品プレビュー）
  - Props: `rowIndex`, `productCode`, `quantity`, `onProductCodeChange`, `onQuantityChange`, `product`, `error`, `isSearching`
  - リアルタイム検索結果を表示

### Organisms（有機体）
**新規作成:**
- `QuickOrderTable` - 複数行入力テーブル
  - Props: `rows`, `onRowChange`, `onAddRows`, `maxRows`, `canAddRows`
  - 行の追加ボタン表示

**リファクタリング:**
- `QuickOrderLineForm` → `QuickOrderMultiLineForm`
  - 20行の初期状態管理
  - 10件ずつ行追加ロジック
  - 最大99行の制限
  - 入力済み商品の検証
  - 一括カート追加処理

### 削除するコンポーネント
- `QuickOrderInputRow` - 単一行入力は不要
- `QuickOrderProductList` - 追加済みリスト表示は不要
- `QuickOrderProductItem` - 商品アイテム表示は不要
- `QuickOrderSummary` - サマリー表示は不要

## データ構造

```typescript
interface QuickOrderRowData {
  id: string;
  productCode: string;
  quantity: number;
  product: ProductSearchResult | null;
  error: ProductSearchError | null;
  isSearching: boolean;
}
```

## 実装フェーズ（TDD）

### Phase 0: Atom - NumberInput Tailwind CSS化（前提条件）
1. テスト作成（既存機能の回帰テスト）
2. styled-jsx → Tailwind CSS変換
3. テスト実行・確認

### Phase 1: Molecule - QuickOrderRow
1. テスト作成
   - 商品コード入力のテスト
   - 数量入力のテスト
   - リアルタイム検索表示のテスト
   - エラー表示のテスト
2. 実装
3. リファクタリング

### Phase 2: Organism - QuickOrderTable
1. テスト作成
   - 初期20行表示のテスト
   - 10件追加ボタンのテスト
   - 最大99行制限のテスト
   - 行変更ハンドラのテスト
2. 実装
3. リファクタリング

### Phase 3: Organism - QuickOrderMultiLineForm
1. テスト作成
   - 初期状態のテスト
   - 行追加ロジックのテスト
   - カート追加のテスト（入力済みのみ）
   - エラーハンドリングのテスト
2. 実装
3. リファクタリング

### Phase 4: 既存コンポーネント削除とpage.tsx更新
1. 不要なコンポーネント削除
2. 不要なテスト削除
3. page.tsxの更新
4. 統合テスト

## UI設計

### レイアウト
```
┌─────────────────────────────────────────────────────┐
│ クイックオーダー                                      │
├─────────────────────────────────────────────────────┤
│ No. │ 商品コード    │ 数量 │ 商品プレビュー           │
├─────┼──────────────┼─────┼────────────────────────┤
│  1  │ [入力欄]     │ [1] │ 商品情報 or 検索中 or エラー │
│  2  │ [入力欄]     │ [1] │                          │
│ ... │              │     │                          │
│ 20  │ [入力欄]     │ [1] │                          │
├─────────────────────────────────────────────────────┤
│          [+ 10件追加] (残り79件追加可能)              │
├─────────────────────────────────────────────────────┤
│                    [カートに追加 (N商品)]            │
└─────────────────────────────────────────────────────┘
```

### スタイリング
- 100% Tailwind CSS
- レスポンシブ対応（モバイルでは縦スクロール）
- 入力行のホバー効果
- 商品検索中のインジケーター
- エラー行の強調表示

## テストケース

### QuickOrderRow.test.tsx
- [ ] 商品コード入力時にonProductCodeChangeが呼ばれること
- [ ] 数量変更時にonQuantityChangeが呼ばれること
- [ ] 商品情報が正しく表示されること
- [ ] 検索中インジケーターが表示されること
- [ ] エラーメッセージが表示されること
- [ ] 行番号が正しく表示されること

### QuickOrderTable.test.tsx
- [ ] 指定された行数が表示されること
- [ ] 10件追加ボタンがクリックできること
- [ ] 最大行数に達したら追加ボタンが無効化されること
- [ ] 残り追加可能件数が正しく表示されること

### QuickOrderMultiLineForm.test.tsx
- [ ] 初期状態で20行表示されること
- [ ] 10件追加で30行になること
- [ ] 最大99行まで追加できること
- [ ] 入力済み商品のみカート追加されること
- [ ] 空行はカート追加されないこと
- [ ] エラー行はカート追加されないこと
- [ ] カート追加成功後に入力がクリアされること

## 技術的考慮事項

### パフォーマンス
- **⚠️ 重要**: 99行 × リアルタイム検索 = 最大99回のAPI呼び出し
  - 解決策1: 各行でuseProductSearchを使用（デバウンス済み）
  - 解決策2: 初期状態では商品コード空のため、API呼び出しは実際の入力時のみ
  - 解決策3: 入力済み行のみ検索状態を保持
- リアルタイム検索のデバウンス処理（既存のuseProductSearch: 300ms）
- 仮想スクロールは初期実装では不要（必要に応じて追加）
- メモ化を活用してレンダリング最適化

### アクセシビリティ
- キーボードナビゲーション対応
- ARIA属性の適切な設定
- エラーメッセージの読み上げ対応

### エラーハンドリング
- 商品が見つからない場合
- 在庫切れの場合
- API エラーの場合
- カート追加失敗の場合

## 見積もり
- Phase 1: 1-2時間（テスト + 実装）
- Phase 2: 1-2時間（テスト + 実装）
- Phase 3: 2-3時間（テスト + 実装）
- Phase 4: 1時間（削除 + 統合）
- **合計**: 5-8時間

## リスク・懸念事項

### 技術的リスク
- 99行の大量入力でパフォーマンスが低下する可能性 → 仮想スクロール検討
- リアルタイム検索で大量のAPI呼び出し → デバウンス処理で対応済み
- ユーザーが入力途中で離脱した場合の状態保存 → 初期実装では対応しない

### UX懸念事項
- **⚠️ 20行表示は画面スクロールが長くなる**
  - 解決策: 初期5-10行 → 必要に応じて追加の方がUX良好かも
  - **要ユーザー確認**: 本当に初期20行が必要か？
- 99行まで増やせるが、実際に使われるシナリオは？
  - 典型的な利用ケース: 10-20商品程度と推測
  - 最大値99は過剰かもしれない
- 商品プレビューを全行表示すると情報過多になる可能性
  - 解決策: プレビューは選択行のみ or コンパクト表示

## 成功基準
- ✅ 20行の初期表示
- ✅ 10件ずつ追加可能（最大99行）
- ✅ 入力済み商品の一括カート追加
- ✅ 全テストパス
- ✅ ビルド成功
- ✅ レスポンシブ対応
- ✅ 既存コンポーネントの削除
